name: Create Release

on:
  workflow_run:
    workflows: ["Release On Merge"]
    types: [completed]
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to release (e.g. v1.2.3)"
        required: true
        type: string

permissions:
  contents: write
  discussions: write

jobs:
  release:
    if: ${{ github.repository == 'BrkRaw/brkraw-sordino' && (github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success') }}
    runs-on: ubuntu-latest
    steps:
      - name: Download release metadata
        if: ${{ github.event_name == 'workflow_run' }}
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: release-metadata
          run-id: ${{ github.event.workflow_run.id }}
          path: .
      - name: Check release metadata
        if: ${{ github.event_name == 'workflow_run' }}
        id: metadata
        run: |
          if [ -f release_metadata.json ]; then
            echo "found=true" >> "$GITHUB_OUTPUT"
          else
            echo "found=false" >> "$GITHUB_OUTPUT"
          fi
      - name: Skip release (no metadata)
        if: ${{ github.event_name == 'workflow_run' && steps.metadata.outputs.found != 'true' }}
        run: |
          echo "release_metadata.json not found; skipping release."
          exit 0
      - name: Resolve tag
        id: tag
        if: ${{ github.event_name == 'workflow_dispatch' || steps.metadata.outputs.found == 'true' }}
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "value=${{ inputs.tag }}" >> "$GITHUB_OUTPUT"
            echo "created=true" >> "$GITHUB_OUTPUT"
          else
            python3 - <<'PY'
            import os
            import json
            from pathlib import Path

            path = Path("release_metadata.json")
            if not path.exists():
                raise SystemExit("release_metadata.json not found")
            data = json.loads(path.read_text(encoding="utf-8"))
            tag = data.get("tag")
            created = data.get("created", "false")
            if not tag:
                raise SystemExit("Tag not found in release metadata")
            with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as handle:
                handle.write(f"value={tag}\n")
                handle.write(f"created={created}\n")
            PY
          fi
      - name: Ensure release needed
        if: ${{ steps.tag.outputs.created != 'true' }}
        run: |
          echo "Release already exists or tag not created; skipping."
          exit 0
      - name: Ensure tag provided
        run: |
          tag="${{ steps.tag.outputs.value }}"
          if [ -z "$tag" ]; then
            echo "Tag not resolved; skipping release."
            exit 0
          fi
      - name: Ensure tag exists
        id: tag_exists
        run: |
          tag="${{ steps.tag.outputs.value }}"
          if git ls-remote --exit-code --tags origin "refs/tags/${tag}" >/dev/null 2>&1; then
            echo "value=true" >> "$GITHUB_OUTPUT"
          else
            echo "Tag ${tag} not found; skipping release."
            echo "value=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
      - uses: actions/checkout@v4
        with:
          ref: ${{ steps.tag.outputs.value }}
      - name: Detect prerelease tag
        id: prerelease
        run: |
          tag="${{ steps.tag.outputs.value }}"
          if echo "$tag" | grep -Eq '(a|b|rc)[0-9]*$'; then
            echo "value=true" >> "$GITHUB_OUTPUT"
          else
            echo "value=false" >> "$GITHUB_OUTPUT"
          fi
      - name: Write release metadata
        run: |
          tag="${{ steps.tag.outputs.value }}"
          prerelease="${{ steps.prerelease.outputs.value }}"
          cat > release_metadata.json <<EOF
          {"tag":"$tag","prerelease":"$prerelease"}
          EOF
      - name: Upload release metadata
        uses: actions/upload-artifact@v4
        with:
          name: release-metadata
          path: release_metadata.json
      - name: Create GitHub Release
        if: ${{ steps.tag_exists.outputs.value == 'true' }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.value }}
          name: ${{ steps.tag.outputs.value }}
          body_path: RELEASE_NOTES.md
          prerelease: ${{ steps.prerelease.outputs.value }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Post release announcement
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          TAG_NAME: ${{ steps.tag.outputs.value }}
          RELEASE_URL: https://github.com/${{ github.repository }}/releases/tag/${{ steps.tag.outputs.value }}
        run: |
          python3 - <<'PY'
          import json
          import os
          from pathlib import Path
          from urllib import request

          token = os.environ.get("GITHUB_TOKEN")
          repo = os.environ["GITHUB_REPOSITORY"]
          tag = os.environ["TAG_NAME"]
          release_url = os.environ["RELEASE_URL"]
          owner, name = repo.split("/")

          notes_path = Path("RELEASE_NOTES.md")
          notes = notes_path.read_text(encoding="utf-8").strip() if notes_path.exists() else ""
          title = f"Release {tag}"
          body = f"[Release {tag}]({release_url})"
          if notes:
              body = f"{body}\\n\\n{notes}"

          query = {
              "query": """
              query($owner: String!, $name: String!) {
                repository(owner: $owner, name: $name) {
                  id
                  discussionCategories(first: 50) {
                    nodes { id name }
                  }
                }
              }
              """,
              "variables": {"owner": owner, "name": name},
          }

          req = request.Request("https://api.github.com/graphql", method="POST")
          req.add_header("Authorization", f"Bearer {token}")
          req.add_header("Content-Type", "application/json")
          data = json.dumps(query).encode("utf-8")
          with request.urlopen(req, data=data) as resp:
              payload = json.loads(resp.read().decode("utf-8"))

          repo_data = payload.get("data", {}).get("repository", {})
          category_id = None
          for node in repo_data.get("discussionCategories", {}).get("nodes", []):
              if node.get("name") == "Announcements":
                  category_id = node.get("id")
                  break
          if not category_id:
              print("Announcements category not found; skipping discussion.")
              raise SystemExit(0)

          mutation = {
              "query": """
              mutation($repoId: ID!, $categoryId: ID!, $title: String!, $body: String!) {
                createDiscussion(input: {repositoryId: $repoId, categoryId: $categoryId, title: $title, body: $body}) {
                  discussion { id url }
                }
              }
              """,
              "variables": {
                  "repoId": repo_data.get("id"),
                  "categoryId": category_id,
                  "title": title,
                  "body": body,
              },
          }

          req = request.Request("https://api.github.com/graphql", method="POST")
          req.add_header("Authorization", f"Bearer {token}")
          req.add_header("Content-Type", "application/json")
          data = json.dumps(mutation).encode("utf-8")
          with request.urlopen(req, data=data) as resp:
              result = json.loads(resp.read().decode("utf-8"))
          url = result.get("data", {}).get("createDiscussion", {}).get("discussion", {}).get("url")
          if url:
              print(f"Created discussion: {url}")
          PY
